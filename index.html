<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>M5Atom CAN v9</title>
    <script>
        function log(msg) {
            const l = document.getElementById('log-box');
            if (l) {
                const d = new Date();
                l.innerHTML = "<div>[" + d.toLocaleTimeString() + "] " + msg + "</div>" + l.innerHTML;
            }
            console.log(msg);
        }
        window.onerror = function (msg, url, line) {
            log("ERR: " + msg + " L:" + line);
            return false;
        };
        // Global function definition
        window.startBle = async function () {
            log("BTN: Event Fired!");
            if (window.isConnecting) return;
            window.isConnecting = true;
            if (!navigator.bluetooth) { log("BT NOT SUPPORTED API"); window.isConnecting = false; return; }
            try {
                document.getElementById('status').textContent = 'Connecting...';
                const SERVICE_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
                const CHARACTERISTIC_UUID_RX = "6e400002-b5a3-f393-e0a9-e50e24dcca9e";
                log("Requesting Device...");
                const device = await navigator.bluetooth.requestDevice({ filters: [{ namePrefix: 'M5Atom' }], optionalServices: [SERVICE_UUID] });
                log("Selected: " + device.name);
                device.addEventListener('gattserverdisconnected', onDisc);
                log("Connecting GATT...");
                const server = await device.gatt.connect();
                log("Getting Service...");
                const service = await server.getPrimaryService(SERVICE_UUID);
                log("Getting Char...");
                window.characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID_RX);
                document.getElementById('status').className = 'status connected';
                document.getElementById('status').textContent = 'Connected (v9)';
                log("SUCCESS! Connected.");
                document.getElementById('main-ui').classList.remove('hidden');
                document.getElementById('btn-connect').style.display = 'none';
            } catch (e) {
                log("Connect Fail: " + e);
                document.getElementById('status').textContent = 'Err';
            }
            window.isConnecting = false;
        };
        function onDisc() {
            log("Disconnected");
            document.getElementById('main-ui').classList.add('hidden');
            document.getElementById('btn-connect').style.display = 'block';
            document.getElementById('status').className = 'status disconnected';
            document.getElementById('status').textContent = 'Disconnected';
        }
    </script>
    <link rel="manifest"
        href="data:application/json;base64,ewogICJuYW1lIjogIk01QXRvbSBDQU4gUmVtb3RlIiwKICAic2hvcnRfbmFtZSI6ICJNNUNBTiIsCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjMTIxMjEyIiwKICAidGhlbWVfY29sb3IiOiAiIzEyMTIxMiIsCiAgImljb25zIjogW10KfQ==">
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #ffffff;
            --primary-color: #bb86fc;
            --success-color: #03dac6;
            --error-color: #cf6679;
            --on-btn-color: #00e676;
            --off-btn-color: #ff1744;
            --input-bg: #ffffff;
            --input-text: #000000;
            --highlight-color: #ff9800;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 10px;
            box-sizing: border-box;
        }
        .header {
            text-align: center;
            margin-bottom: 10px;
            width: 100%;
            max-width: 500px;
        }
        .status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            background: #333;
            font-size: 0.8rem;
            color: #aaa;
            margin-top: 5px;
        }
        .status.connected {
            color: var(--success-color);
            border: 1px solid var(--success-color);
        }
        .container {
            width: 100%;
            max-width: 500px;
            background: #2d2d2d;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }
        label {
            font-size: 0.75rem;
            color: #ccc;
            display: block;
            margin-bottom: 2px;
        }
        input[type="text"],
        input[type="number"],
        select {
            background: var(--input-bg);
            color: var(--input-text);
            border: 1px solid #999;
            border-radius: 4px;
            padding: 4px;
            font-size: 0.9rem;
            box-sizing: border-box;
        }
        .row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }
        .id-group {
            flex: 0 0 80px;
        }
        .byte-container {
            display: flex;
            gap: 4px;
            justify-content: space-between;
            overflow-x: auto;
            padding-bottom: 5px;
            margin-bottom: 5px;
        }
        .byte-col {
            flex: 1;
            min-width: 35px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        .byte-col input {
            width: 100%;
            text-align: center;
            font-family: monospace;
            padding: 4px 0;
        }
        .byte-col span {
            font-size: 0.7rem;
            color: #888;
        }
        .sw-btn {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 4px;
            border: none;
            font-size: 0.7rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.1s;
        }
        .sw-btn.on {
            background-color: var(--on-btn-color);
            color: #000;
            box-shadow: 0 0 5px var(--on-btn-color);
        }
        .sw-btn.off {
            background-color: #444;
            color: #888;
            border: 1px solid #555;
        }
        .array-config {
            background: #222;
            padding: 5px 8px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .array-config select {
            font-size: 0.8rem;
            padding: 2px;
            width: 60px;
        }
        button.main-btn {
            border: none;
            border-radius: 6px;
            padding: 10px;
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            color: white;
            width: 100%;
            margin-top: 5px;
            background: #555;
        }
        button.main-btn:active {
            background: #777;
        }
        #btn-connect {
            background: #ff4444;
            color: white;
            margin-bottom: 20px;
            font-size: 1.2rem;
            padding: 20px;
            border: 2px solid white;
            width: 100%;
            max-width: 500px;
        }
        .hidden {
            display: none;
        }
        .custom-area {
            margin-top: 15px;
            border-top: 1px solid #444;
            padding-top: 10px;
        }
        .custom-title {
            font-size: 0.8rem;
            color: #888;
            margin-bottom: 5px;
        }
        .custom-row {
            display: flex;
            gap: 5px;
        }
        .btn-lg {
            flex: 1;
            padding: 15px;
            font-size: 1rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            color: white;
            font-weight: bold;
        }
        #log-box {
            width: 95%;
            height: 120px;
            background: #000;
            color: #0f0;
            font-family: monospace;
            font-size: 0.7rem;
            overflow-y: scroll;
            margin: 10px auto;
            padding: 5px;
            border: 1px solid #333;
            text-align: left;
        }
    </style>
</head>
<body>
    <button id="btn-connect" onclick="startBle()" ontouchstart="startBle()">
        CONNECT DEVICE (CLICK HERE)
    </button>
    <div id="log-box">Log v9 initialized...</div>
    <div class="header">
        <h3 style="margin:5px 0;">M5Atom CAN Remote (v9)</h3>
        <div id="status" class="status disconnected">init...</div>
    </div>
    <div id="main-ui" class="container hidden">
        <div class="row">
            <div class="id-group">
                <label>ID (Hex)</label><input type="text" id="can-id" value="500">
            </div>
            <div style="flex:1;"></div>
            <div style="text-align:right;">
                <label>Global Bit Target</label>
                <div class="array-config">
                    <label style="margin:0; margin-right:5px; color:#fff;">Bit:</label>
                    <select id="global-bit">
                        <option value="0">0</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                    </select>
                </div>
            </div>
        </div>
        <div style="font-size:0.8rem; color:#ccc; margin-bottom:5px;">Data (Decimal) & Per-Byte Switch</div>
        <div class="byte-container" id="byte-cols"></div>
        <button id="btn-send-manual" class="main-btn">Send Current Data (Manual)</button>
        <div class="custom-area">
            <div class="custom-title">Custom Big Button (Adv)</div>
            <div class="row" style="margin-bottom:5px;">
                <div style="flex:1;"><label>Byte</label><select id="adv-byte">
                        <option value="0">0</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                    </select></div>
                <div style="flex:1;"><label>Bit</label><select id="adv-bit">
                        <option value="0">0</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                    </select></div>
            </div>
            <div class="custom-row">
                <button id="btn-on-custom" class="btn-lg">ON</button>
                <button id="btn-off-custom" class="btn-lg">OFF</button>
            </div>
        </div>
    </div>
    <script>
        // Init UI
        try {
            const byteCols = document.getElementById('byte-cols');
            for (let i = 0; i < 8; i++) {
                let col = document.createElement('div');
                col.className = 'byte-col';
                col.innerHTML = `
                    <input type="number" id="b${i}" value="0" min="0" max="255">
                    <button id="sw${i}" class="sw-btn off">OFF</button>
                    <span>${i}</span>
                `;
                byteCols.appendChild(col);
            }
            log("UI built");
        } catch (e) { log("Init Error: " + e); }
        // Refs
        const els = {
            id: document.getElementById('can-id'),
            gBit: document.getElementById('global-bit'),
            advByte: document.getElementById('adv-byte'),
            advBit: document.getElementById('adv-bit'),
        };
        function getBitMask(bitIdx) { return (1 << bitIdx); }
        function updateSwitches() {
            try {
                let tBit = parseInt(els.gBit.value);
                let mask = getBitMask(tBit);
                for (let i = 0; i < 8; i++) {
                    let val = parseInt(document.getElementById('b' + i).value) || 0;
                    let btn = document.getElementById('sw' + i);
                    if ((val & mask) !== 0) {
                        btn.className = 'sw-btn on';
                        btn.textContent = 'ON';
                    } else {
                        btn.className = 'sw-btn off';
                        btn.textContent = 'OFF';
                    }
                }
                save();
            } catch (e) { log("Update Error: " + e); }
        }
        function toggleByte(byteIdx) {
            log("Toggle B" + byteIdx);
            let tBit = parseInt(els.gBit.value);
            let mask = getBitMask(tBit);
            let input = document.getElementById('b' + byteIdx);
            let val = parseInt(input.value) || 0;
            if ((val & mask) !== 0) val &= ~mask; else val |= mask;
            input.value = val;
            updateSwitches();
            sendManual();
        }
        function save() {
            try {
                localStorage.setItem('c9_id', els.id.value);
                localStorage.setItem('c9_gbit', els.gBit.value);
                for (let i = 0; i < 8; i++) localStorage.setItem('c9_b' + i, document.getElementById('b' + i).value);
            } catch (e) { }
        }
        function load() {
            try {
                if (localStorage.getItem('c9_id')) els.id.value = localStorage.getItem('c9_id');
                if (localStorage.getItem('c9_gbit')) els.gBit.value = localStorage.getItem('c9_gbit');
                for (let i = 0; i < 8; i++) if (localStorage.getItem('c9_b' + i)) document.getElementById('b' + i).value = localStorage.getItem('c9_b' + i);
                updateSwitches();
            } catch (e) { log("Load Error: " + e); }
        }
        // Listeners
        try {
            for (let i = 0; i < 8; i++) {
                document.getElementById('b' + i).addEventListener('input', updateSwitches);
                document.getElementById('sw' + i).addEventListener('click', () => toggleByte(i));
            }
            els.gBit.addEventListener('change', updateSwitches);
            document.getElementById('btn-send-manual').addEventListener('click', sendManual);
            document.getElementById('btn-on-custom').addEventListener('click', () => sendAdv(true));
            document.getElementById('btn-off-custom').addEventListener('click', () => sendAdv(false));
            load();
            document.getElementById('status').textContent = 'Ready (v9)';
            log("Init Complete. Ready.");
        } catch (e) { log("Listener Error: " + e); }
        async function sendManual() {
            if (!window.characteristic) { log("Send: No Conn"); return; }
            let hex = '';
            for (let i = 0; i < 8; i++) {
                let v = parseInt(document.getElementById('b' + i).value) || 0;
                hex += v.toString(16).padStart(2, '0');
            }
            const cmd = `CAN:${els.id.value}:${hex}`;
            try { await window.characteristic.writeValue(new TextEncoder().encode(cmd)); log("Sent: " + cmd); } catch (e) { log("Send Fail: " + e); }
        }
        async function sendAdv(isOn) {
            let tB = parseInt(els.advByte.value);
            let tBit = parseInt(els.advBit.value);
            let mask = (1 << tBit);
            let input = document.getElementById('b' + tB);
            let val = parseInt(input.value) || 0;
            if (isOn) val |= mask; else val &= ~mask;
            input.value = val;
            updateSwitches();
            sendManual();
        }
    </script>
</body>
</html>
