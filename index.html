<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>M5Atom CAN Remote</title>
    <link rel="manifest"
        href="data:application/json;base64,ewogICJuYW1lIjogIk01QXRvbSBDQU4gUmVtb3RlIiwKICAic2hvcnRfbmFtZSI6ICJNNUNBTiIsCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjMTIxMjEyIiwKICAidGhlbWVfY29sb3IiOiAiIzEyMTIxMiIsCiAgImljb25zIjogW10KfQ==">
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #ffffff;
            --primary-color: #bb86fc;
            --success-color: #03dac6;
            --error-color: #cf6679;
            --on-btn-color: #00e676;
            --off-btn-color: #ff1744;
            --input-bg: #ffffff;
            --input-text: #000000;
            --highlight-color: #ff9800;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 10px;
            box-sizing: border-box;
        }
        /* Header & Status */
        .header {
            text-align: center;
            margin-bottom: 15px;
            width: 100%;
            max-width: 450px;
        }
        .status {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 15px;
            background: #333;
            font-size: 0.8rem;
            color: #aaa;
            margin-top: 5px;
        }
        .status.connected {
            color: var(--success-color);
            border: 1px solid var(--success-color);
        }
        .status.disconnected {
            color: var(--error-color);
        }
        .container {
            width: 100%;
            max-width: 450px;
            background: #2d2d2d;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }
        label {
            font-size: 0.8rem;
            color: #ccc;
            display: block;
            margin-bottom: 4px;
        }
        input[type="text"],
        input[type="number"],
        select {
            background: var(--input-bg);
            color: var(--input-text);
            border: 1px solid #999;
            border-radius: 4px;
            padding: 6px;
            font-size: 1rem;
            box-sizing: border-box;
        }
        /* ID Input */
        .row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }
        .id-group {
            flex: 0 0 100px;
        }
        .id-group input {
            width: 100%;
            font-family: monospace;
        }
        /* Data Bytes (Horizontal) */
        .data-label {
            font-size: 0.9rem;
            margin-bottom: 5px;
            color: #eee;
        }
        .byte-container {
            display: flex;
            gap: 4px;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .byte-col {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .byte-col input {
            width: 100%;
            padding: 5px 2px;
            text-align: center;
            font-size: 0.9rem;
            font-family: monospace;
            min-width: 0;
        }
        .byte-col span {
            font-size: 0.7rem;
            color: #888;
            margin-top: 2px;
        }
        .byte-col.active input {
            border: 2px solid var(--highlight-color);
            background-color: #fff8e1;
        }
        /* Buttons */
        button {
            border: none;
            border-radius: 6px;
            padding: 12px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            color: white;
            width: 100%;
            transition: opacity 0.2s;
        }
        button:active {
            opacity: 0.8;
        }
        #btn-connect {
            background: var(--primary-color);
            color: #000;
            margin-bottom: 10px;
        }
        #btn-send-manual {
            background: #555;
            margin-top: 5px;
            font-size: 0.9rem;
            padding: 8px;
        }
        .switch-area {
            background: #3a3a3a;
            margin-top: 20px;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #444;
        }
        .switch-title {
            font-size: 0.9rem;
            color: #bbb;
            margin-bottom: 10px;
            border-bottom: 1px solid #555;
            padding-bottom: 5px;
        }
        .config-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .config-group {
            flex: 1;
        }
        .btn-row {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        #btn-on {
            background: var(--on-btn-color);
            flex: 1;
        }
        #btn-off {
            background: var(--off-btn-color);
            flex: 1;
        }
        /* Toggle LSB/MSB */
        .radio-group {
            display: flex;
            background: #222;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }
        .radio-opt {
            flex: 1;
            text-align: center;
            padding: 5px;
            font-size: 0.75rem;
            color: #888;
            cursor: pointer;
            border-right: 1px solid #444;
        }
        .radio-opt:last-child {
            border-right: none;
        }
        .radio-opt.active {
            background: #666;
            color: white;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <h2 style="margin:5px 0;">M5Atom CAN</h2>
        <div id="status" class="status disconnected">Not Connected</div>
    </div>
    <button id="btn-connect">CONNECT DEVICE</button>
    <div id="main-ui" class="container hidden">
        <div class="row">
            <div class="id-group">
                <label>ID (Hex)</label>
                <input type="text" id="can-id" value="500" placeholder="500">
            </div>
            <div style="flex:1; display:flex; align-items:flex-end;">
                <label style="margin-bottom:8px; margin-left:10px;">Length: 8</label>
            </div>
        </div>
        <div class="data-label">Data (Decimal 0-255)</div>
        <div class="byte-container" id="byte-inputs">
            <!-- 0-7 Inputs Generated JS -->
        </div>
        <!-- Manual Send -->
        <button id="btn-send-manual">Send Frame (Manual)</button>
        <!-- Remote Switch Config -->
        <div class="switch-area">
            <div class="switch-title">Remote Switch Configuration</div>
            <div class="config-row">
                <div class="config-group">
                    <label>Target Byte (0-7)</label>
                    <select id="target-byte">
                        <option value="0">Byte 0</option>
                        <option value="1">Byte 1</option>
                        <option value="2">Byte 2</option>
                        <option value="3">Byte 3</option>
                        <option value="4">Byte 4</option>
                        <option value="5">Byte 5</option>
                        <option value="6">Byte 6</option>
                        <option value="7">Byte 7</option>
                    </select>
                </div>
                <div class="config-group">
                    <label>Target Bit (0-7)</label>
                    <select id="target-bit">
                        <option value="0">0</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                    </select>
                </div>
            </div>
            <label>Bit Order</label>
            <div class="radio-group">
                <div class="radio-opt active" id="opt-lsb" onclick="setOrder('LSB')">LSB First (Std)</div>
                <div class="radio-opt" id="opt-msb" onclick="setOrder('MSB')">MSB First (Rev)</div>
            </div>
            <div class="btn-row">
                <button id="btn-on">ON (1)</button>
                <button id="btn-off">OFF (0)</button>
            </div>
            <div style="font-size:0.7rem; color:#aaa; margin-top:5px; text-align:center;">
                ON/OFF buttons send the data above but toggle the selected bit.
            </div>
        </div>
    </div>
    <script>
        const SERVICE_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
        const CHARACTERISTIC_UUID_RX = "6e400002-b5a3-f393-e0a9-e50e24dcca9e";
        let device, server, service, characteristic;
        let bitOrder = 'LSB';
        // Init Byte Inputs
        const byteContainer = document.getElementById('byte-inputs');
        for (let i = 0; i < 8; i++) {
            let col = document.createElement('div');
            col.className = 'byte-col';
            col.id = 'col-' + i;
            col.innerHTML = `<input type="number" id="b${i}" value="0" min="0" max="255"><span>${i}</span>`;
            byteContainer.appendChild(col);
        }
        // Refs
        const els = {
            id: document.getElementById('can-id'),
            tByte: document.getElementById('target-byte'),
            tBit: document.getElementById('target-bit'),
            lsb: document.getElementById('opt-lsb'),
            msb: document.getElementById('opt-msb')
        };
        function setOrder(mode) {
            bitOrder = mode;
            els.lsb.className = mode === 'LSB' ? 'radio-opt active' : 'radio-opt';
            els.msb.className = mode === 'MSB' ? 'radio-opt active' : 'radio-opt';
            save();
        }
        function highlight() {
            let tB = parseInt(els.tByte.value);
            for (let i = 0; i < 8; i++) {
                let col = document.getElementById('col-' + i);
                if (i === tB) col.classList.add('active');
                else col.classList.remove('active');
            }
            save();
        }
        function save() {
            localStorage.setItem('can4_id', els.id.value);
            localStorage.setItem('can4_tb', els.tByte.value);
            localStorage.setItem('can4_tbit', els.tBit.value);
            localStorage.setItem('can4_order', bitOrder);
            for (let i = 0; i < 8; i++) localStorage.setItem('can4_b' + i, document.getElementById('b' + i).value);
        }
        function load() {
            if (localStorage.getItem('can4_id')) els.id.value = localStorage.getItem('can4_id');
            if (localStorage.getItem('can4_tb')) els.tByte.value = localStorage.getItem('can4_tb');
            if (localStorage.getItem('can4_tbit')) els.tBit.value = localStorage.getItem('can4_tbit');
            if (localStorage.getItem('can4_order')) setOrder(localStorage.getItem('can4_order'));
            for (let i = 0; i < 8; i++) {
                if (localStorage.getItem('can4_b' + i)) document.getElementById('b' + i).value = localStorage.getItem('can4_b' + i);
            }
            highlight();
        }
        els.tByte.addEventListener('change', highlight);
        els.tBit.addEventListener('change', highlight);
        for (let i = 0; i < 8; i++) document.getElementById('b' + i).addEventListener('input', save);
        document.getElementById('btn-connect').addEventListener('click', connect);
        document.getElementById('btn-send-manual').addEventListener('click', () => send(null)); // null = no toggle
        document.getElementById('btn-on').addEventListener('click', () => send(true));
        document.getElementById('btn-off').addEventListener('click', () => send(false));
        load();
        async function connect() {
            try {
                document.getElementById('status').textContent = 'Connecting...';
                device = await navigator.bluetooth.requestDevice({ filters: [{ namePrefix: 'M5Atom' }], optionalServices: [SERVICE_UUID] });
                device.addEventListener('gattserverdisconnected', () => {
                    document.getElementById('main-ui').classList.add('hidden');
                    document.getElementById('btn-connect').classList.remove('hidden');
                    document.getElementById('status').className = 'status disconnected';
                    document.getElementById('status').textContent = 'Disconnected';
                });
                server = await device.gatt.connect();
                service = await server.getPrimaryService(SERVICE_UUID);
                characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID_RX);
                document.getElementById('status').className = 'status connected';
                document.getElementById('status').textContent = 'Connected';
                document.getElementById('main-ui').classList.remove('hidden');
                document.getElementById('btn-connect').classList.add('hidden');
            } catch (e) { console.error(e); document.getElementById('status').textContent = 'Error'; }
        }
        async function send(toggleState) {
            if (!characteristic) return;
            let bytes = new Uint8Array(8);
            for (let i = 0; i < 8; i++) {
                let v = parseInt(document.getElementById('b' + i).value);
                bytes[i] = isNaN(v) ? 0 : v;
            }
            // If toggleState is boolean, apply mapping
            if (toggleState !== null) {
                let tB = parseInt(els.tByte.value);
                let tBit = parseInt(els.tBit.value);
                let actualBit = (bitOrder === 'LSB') ? tBit : (7 - tBit);
                if (toggleState) bytes[tB] |= (1 << actualBit);
                else bytes[tB] &= ~(1 << actualBit);
            }
            let hex = '';
            for (let i = 0; i < 8; i++) hex += bytes[i].toString(16).padStart(2, '0');
            const cmd = `CAN:${els.id.value}:${hex}`;
            try { await characteristic.writeValue(new TextEncoder().encode(cmd)); } catch (e) { console.error(e); }
        }
    </script>
</body>
</html>
